# 사주 계산 기준(현재 구현)

이 문서는 **현재 백엔드 구현(`backend/app/saju.py`)이 실제로 무엇을 기준으로 계산하는지**를 기록합니다.

> 주의: 현재 구현은 ‘전통 만세력 앱’과 동일한 정밀도를 목표로 한 엔진이 아니라,
> 데모/프로토타입 수준의 단순화된 모델입니다.

## 1) 시간 미상 처리

- 입력 `birth_time`이 `null`(또는 빈 값)인 경우:
  - **시주(hour pillar)는 계산하지 않고 제외합니다.**
  - 즉, `chart.hour`가 `None`이 되며, 오행 집계에서도 hour pillar가 빠집니다.
- 정확도 안내:
  - `birth_time`이 없으면 `accuracy_note`에
    - `"출생시간 미입력으로 시주가 제외되어 분석 정확도가 낮아질 수 있음"`
    가 포함됩니다.

### (옵션 제안) 12개 시주 후보 범위 요약

현재는 미구현입니다. 구현 방향은 아래 중 하나가 현실적입니다.

- **A안(범위):** 12개 시주(子~亥)를 모두 넣어 오행점수/부족오행이 어떻게 달라지는지 범위를 반환
- **B안(대표값):** 12개 결과의 중앙값/최빈값을 대표로 보여주고, 변동 폭만 함께 표시

## 2) 달력/절기 기준

현재 `ChartInput`에는 `calendar_type`, `is_leap_month`, `timezone` 필드가 있습니다.

### 절기월(24절기/입춘 기준) 반영

월주(月柱)는 이제 **절기월(節氣月)** 기준으로 계산합니다.

다만 전통 만세력의 월 경계는 보통 24절기 전체가 아니라 **12중기(中氣)** 를 사용하므로,
현재 구현도 **중기(30° 간격: 0, 30, ..., 330)** 를 월 경계로 사용합니다.

- 중기 경계 시각은 Skyfield로 계산한 태양 황경 통과 시각을 사용합니다.
- 경계가 없는 날(대부분의 날)은 “가장 최근 과거의 중기 경계”를 찾아 그 각도에 따라 절기월을 판정합니다.

### 시간 미상 정책 C(월주 후보 2개)



---

## 케이스 제공 템플릿(테스트 우선 방식)

만세력 앱과의 불일치를 **일반 규칙으로 정합**하기 위해, 아래 형식으로 케이스를 주시면
케이스 1개당 테스트 1개를 추가하고 → 실패 원인을 분리해 → 엔진 규칙을 수정합니다.

아래 템플릿을 그대로 복사해서 보내주세요.

- 입력(필수)
  - `birth_date`: `YYYY-MM-DD` (양력, KST 기준 날짜)
  - `birth_time`: `HH:MM` 또는 `null`(시간 미상)
  - `timezone`: 기본 `Asia/Seoul`
  - `gender`: `M`/`F` (현재 기둥 계산에는 영향 없지만 메타로 유지)

- 앱 정답(필수)
  - `year_pillar`: 예) `乙亥`
  - `month_pillar`: 예) `甲申`
  - `day_pillar`: 예) `辛卯`
  - `hour_pillar`: 예) `辛卯` (시간 미상이면 `null`)

- 힌트(선택)
  - `tags`: `절기경계`, `자시경계(23시)`, `시간미상`, 등
  - 스크린샷(가능하면): 년주/월주/일주/시주 4개가 한 화면에 보이도록

### 예시

```json
{
  "birth_date": "1995-08-28",
  "birth_time": "05:30",
  "timezone": "Asia/Seoul",
  "gender": "M",
  "year_pillar": "乙亥",
  "month_pillar": "甲申",
  "day_pillar": "辛卯",
  "hour_pillar": "辛卯",
  "tags": ["기준샘플"]
}
```

> 기존 호환을 위해 `chart.month_pillar`는 계속 단일 값(대표값)을 유지합니다.

### 아직 미구현/제한

- 양력/음력 변환: 미구현(입력 `calendar_type=LUNAR`는 아직 계산에 반영되지 않음)
- 윤달 처리: 미구현
- 타임존: 현재 절기 판정 로직은 KST(Asia/Seoul)를 기준으로 구현(후속 확장 가능)

- 양력/음력 변환: 미구현
- 윤달 처리: 미구현
- 절기(입춘) 기준 월주: 미구현

현재 월주는 **그레고리력 월(month) 숫자**로만 결정됩니다.

## 3) 월주/일주/년주 산출 방식(현재 구현)

- 년주:
  - 기준년 1984년을 甲子년으로 두고 `(birth_year - 1984) % 60`
- 월주:
  - 절기월 인덱스(寅월=1)를 절기 경계(태양 황경 15° 격자)로 판정
  - 월지(branch): 寅부터 시작해 절기월 인덱스에 매핑
  - 월간(stem): 전통 규칙(오호둔, 五虎遁)
    - 연간 -> 寅월 월간 고정: 甲/己→丙, 乙/庚→戊, 丙/辛→庚, 丁/壬→壬, 戊/癸→甲
    - 이후 월이 하나 진행할 때마다 천간도 하나씩 진행
  - 시간 미상 + 절기 경계일이면 `month_pillars`로 후보 2개 반환 가능
- 일주:
  - 기준일 1900-01-31을 참조로 하여 `(target - reference).days % 60`
  - 전통 만세력 샘플과의 정합을 위해 `DAY_SEXAGENARY_OFFSET` 보정값을 적용
- 시주:
  - `birth_time`이 있을 때만 계산

## 4) 오행 집계 로직(현재 구현)

현재 오행 점수는 다음을 합산합니다.

- 천간 오행: `STEM_WEIGHTS`로 가중치 합산
- 지지(본기) 오행: `BRANCH_WEIGHTS`로 가중치 합산
- 장간(지장간): 지지 가중치의 0.5를 추가로 배분

가중치:

- 천간(Stem)
  - year 1.0, month 1.2, day 1.5, hour 0.8
- 지지(Branch)
  - year 1.0, month 1.4, day 1.2, hour 0.8

정규화:

- `elements_norm`: 전체 점수 대비 백분율(%)로 환산

부족 오행:

- `top_deficiencies`는 `elements_norm` 오름차순 정렬 전체 리스트입니다.
- `main_deficiency = top_deficiencies[0]`

### 합충형파해 / 월령 가중치

- 현재 구현에는 **미반영** 입니다.

## 5) deficiencyLabel(부족오행) ‘화 고정’ 버그 점검 결과

- 동일하게 시간 미상(`birth_time=null`)을 넣어도, 날짜에 따라 부족오행이 달라집니다.
- 예시(코드로 확인):
  - 1990-01-01 → water
  - 1995-04-01 → earth
  - 2000-08-15 → fire
  - 1984-02-02 → metal

즉, **백엔드의 부족오행 계산 자체가 fire로 고정되는 증상은 재현되지 않았습니다.**

다만 프론트에서 ‘항상 화로 보이는’ 현상은 아래 원인 가능성이 큽니다.

- 프론트가 `deficiencyKey`를 계산할 때, 특정 fallback이 `"earth"`로 되어 있음
- 또는 캐시된 결과를 계속 재사용하여 같은 deficiencyLabel이 반복 표출

## 6) 요청하신 동일 입력 raw 결과(/api/analysis)

입력:

- birth_date: 1995-04-01
- gender: M
- calendar_type: SOLAR
- birth_time: null
- timezone: Asia/Seoul

결과 요약:

- chart
  - year: 乙亥
  - month: 庚巳
  - day: 壬午
  - hour: null
- elements_norm
  - wood 12.64
  - fire 37.8
  - earth 3.3
  - metal 15.49
  - water 30.77
- top_deficiencies: [earth, wood, metal, water, fire]
- accuracy_note: 출생시간 미입력으로 시주가 제외되어 분석 정확도가 낮아질 수 있음
